---
title: "Employment Visual"
author: "Xiang XU"
output:
  pdf_document:
    toc: true
    toc_depth: 4
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
pacman::p_load(data.table, plyr, dplyr, stringr, ggplot2, maps, 
               bit64, RcolorBrewer, choroplethr,sqldf, magrittr)
```

# Intro

This project will help us explore employment data came from United States Department of Labor. We will use pay and benefits data in 2018.

## Read data
```{r}
ann2018 <- fread('data/2018.annual.singlefile.csv')
```

## How to instore data into SQLite
```{r,eval=FALSE}
# SQLite installed
sqldf('attach blsdb as new')
read.csv.sql('data/2018.annual.singlefile.csv',
             sql = 'create table main.ann2018 as select * from file',
             dbname = 'blsdb')
# now the data all in SQLite database but not in R
# then read data into R
ann2018 <- sqldf('select * from main.ann2018', dbname = 'blsdb')
```

## View
```{r}
dim(ann2018)
head(ann2018,3)
```

## Get, merge and add additional information
```{r}
for (u in c('agglevel', 'area' ,'industry', 'ownership','size')){
  assign(u,  fread(paste0('data/',u,'_titles.csv'))   )
}
```

```{r}
intersect(names(ann2018), names(agglevel))
intersect(names(ann2018), names(area))
intersect(names(ann2018), names(industry))
intersect(names(ann2018), names(ownership))
intersect(names(ann2018), names(size))
```

### Join data  
```{r}
title <- c('agglevel','industry', 'ownership','size')
ann2018_full <- ann2018

for (i in 1:length(title)){
  eval(parse(text = paste0('ann2018_full <- left_join(ann2018_full,',title[i],')')))
}
```

## Add geographic information

### view
```{r}
head(area)
```

### capitalize
```{r}
# Capitalize the first letter
simpleCap <- function(x){
  if(!is.na(x)){
    s <- strsplit(x,' ')[[1]]
    # print( paste0("strsplit(x,' '):",strsplit(x,' ')))
    # print( paste0("strsplit(x,' ')[1]:",strsplit(x,' ')[1]))
    # print(paste0("s:",s))
    # print(substring(s,1))
    # print(substring(s,1,1))
    # print(toupper(substring(s,1,1)))
    # print(substring(s,2))
    paste(toupper(substring(s,1,1)), substring(s,2),sep= '', collapse = ' ' )
    
  }else {NA}
}

```

### county fips & name
```{r}
data("county.fips")
head(county.fips)
# to acieve data matching, fill in 'fips'
county.fips$fips <- str_pad(county.fips$fips,width = 5, pad = '0', side = 'left')
head(county.fips)

```

```{r}
# extract city name from polyname
county.fips$county <- sapply(
  gsub('([a-z\ ]+),([a-z\ ]+)', '\\2' , as.character(county.fips$polyname) ),
  simpleCap )
county.fips <- unique(county.fips)
head(county.fips)
```

### state fips & name
```{r}
data("state.fips")
head(state.fips)
state.fips$fips <- str_pad(state.fips$fips, width = 2, pad = '0', side = 'left')
# extract city name from polyname
state.fips$state <- sapply(
  gsub('([a-z\ ]+):([a-z\ \\]+)', '\\1' , as.character(state.fips$polyname) ),
  simpleCap )
head(state.fips)

mystate <- unique(state.fips[,c('fips', 'abb', 'state')])
lower48 <-  setdiff(unique(state.fips$state), c('Hawaii', 'Alaska')) 
```

### combine all geographic data
```{r}
myarea <- merge(area, county.fips, 
                by.x = 'area_fips', by.y = 'fips', all.x =TRUE)

myarea$state_fips <- substr(myarea$area_fips,1,2)
myarea <- merge(myarea, mystate, by.x = 'state_fips', by.y = 'fips', all.x = T)
```

### combine all geographic + employment data and save to .rda
```{r}
ann2018_full <- left_join(ann2018_full, myarea)
ann2018_full <- filter(ann2018_full, state %in% lower48)
save(ann2018_full, file ='data/ann2018full.rda', compress = T )
```


## Get pay + employment data from county & state level

### state level
#### focus on averge annual pay + averge annual employment
```{r}
d.state <- filter(ann2018_full, agglvl_code == 50) # state summary
d.state <- select(d.state, state, avg_annual_pay, annual_avg_emplvl)
```

#### discretization, create var `wage` `empquatile`
```{r create var}
d.state$wage <- cut(d.state$avg_annual_pay,
                    quantile(d.state$avg_annual_pay,
                             c(seq(0,.8,by=.2), .9, .95,.99,1) 
                             )
                    )
d.state$empquatile <- cut(d.state$annual_avg_emplvl,
                          quantile(d.state$annual_avg_emplvl,
                                   c(seq(0,.8,by=.2), .9, .95,.99,1) 
                                   )
                          )
```

```{r label var}
x <- quantile(d.state$avg_annual_pay, c(seq(0,.8,by=.2), .9, .95,.99,1) )
xx <- paste0(round(x/1000),'K')
Labs <- paste(xx[-length(xx)],xx[-1],sep='-')
levels(d.state$wage) <- Labs

x <- quantile(d.state$annual_avg_emplvl, c(seq(0,.8,by=.2), .9, .95,.99,1) )
xx <- ifelse(x>1000, paste0(round(x/1000),'K'),round(x))
Labs <- paste(xx[-length(xx)],xx[-1],sep='-')
levels(d.state$empquatile) <- Labs
```


### county level
#### focus on averge annual pay + averge annual employment
```{r, eval=FALSE}
d.county <- filter(ann2018_full, agglvl_code == 70) # county summary
d.county <- select(d.county, county, avg_annual_pay, annual_avg_emplvl)
```

#### discretization, create var `wage` `empquatile`
```{r create county var, eval=FALSE}
d.county$wage <- cut(d.county$avg_annual_pay,
                    quantile(d.county$avg_annual_pay,
                             c(seq(0,.8,by=.2), .9, .95,.99,1) 
                             )
                    )
d.county$empquatile <- cut(d.county$annual_avg_emplvl,
                          quantile(d.county$annual_avg_emplvl,
                                   c(seq(0,.8,by=.2), .9, .95,.99,1) 
                                   )
                          )
```

```{r label county var, eval=FALSE}
x <- quantile(d.county$avg_annual_pay, c(seq(0,.8,by=.2), .9, .95,.99,1) )
xx <- ifelse(x>1000, paste0(round(x/1000),'K'),round(x))
Labs <- paste(xx[-length(xx)],xx[-1],sep='-')
levels(d.county$wage) <- Labs

x <- quantile(d.county$annual_avg_emplvl, c(seq(0,.8,by=.2), .9, .95,.99,1) )
xx <- ifelse(x>1000, paste0(round(x/1000),'K'),round(x))
Labs <- paste(xx[-length(xx)],xx[-1],sep='-')
levels(d.county$empquatile) <- Labs
```

#### use `Discretize` function 
```{r Discretize func}
# create `Discretize` function
Discretize <- function(x, breaks = NULL){
  if(is.null(breaks)){
    
    breaks <- quantile(x, c(seq(0,.8,by=.2), .9, .95,.99,1) )
    
    if(sum(breaks==0) >1){
      tmp <- which(breaks ==0, arr.ind = TRUE)
      breaks <- breaks[max(tmp):length(breaks)]
    }
    
  }
  
  x.discrete <- cut(x, breaks, include.lowest = T)
  breaks.eng <- ifelse( breaks>1000, paste0(round(breaks/1000),'K'),round(breaks))
  Labs <- paste(breaks.eng[-length(breaks.eng)],breaks.eng[-1],sep='-')
  levels(x.discrete) <- Labs
  
  return(x.discrete)
}

```
```{r apply func generate county data}
#  apply
d.county <- ann2018_full %>%
  filter(agglvl_code == 70)%>%
  select(state, county , abb, avg_annual_pay, annual_avg_emplvl) %>%
  mutate( wage = Discretize(avg_annual_pay), 
          empquatile = Discretize(annual_avg_emplvl))
```


Now data all prepared.

---------


## Visualize geographic features

### extract map data
```{r}
state_df <- map_data('state')
cty_df <- map_data('county')
head(state_df)
head(cty_df)
```


### data transformation to match
```{r}
transform_mapdata <- function(x){
  names(x)[5:6] <- c('state', 'county')
  
  for( u in c('state', 'county')){
    x[,u] <- sapply(x[,u], simpleCap)
  }
  return(x)
}
state_df <- transform_mapdata(state_df)
cty_df <- transform_mapdata(cty_df)
head(state_df)
head(cty_df)
```

### connect map data above with `d.state`
```{r,fig.width=8, fig.height=4}
chor_state <- left_join(state_df, d.state, by ='state')

ggplot(chor_state, aes(long, lat, group = group)) + 
  geom_polygon(aes(fill =wage))+
  geom_path(color = 'black', size =.2)+
  scale_fill_brewer(palette = "PuRd")+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank())
  
```

```{r add text,eval=FALSE, echo=FALSE}
chor_state <- left_join(state_df, d.state, by ='state')
chor_state <- left_join(chor_state, mystate, by = 'state')

midpos <- function(x) mean(range(x,na.rm=TRUE))
state_label <- ddply(chor_state,.(state),colwise(midpos,.(long,lat)))
state_label  <-  left_join(state_label,
                           chor_state %<>%  select(state, group, abb)%>% unique())

ggplot(chor_state, aes(long, lat, group = group)) +
  geom_polygon(aes(fill =wage))+
  geom_path(color = 'black', size =.2)+
  scale_fill_brewer(palette = "PuRd")+
  geom_text(aes(label=abb), data = state_label)+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank())
  
```

### connect map data above with `d.state`
```{r,fig.width=8, fig.height=4}
chor_cty <- left_join(cty_df, d.county,by = c("state", "county"))

ggplot(chor_cty, aes(long, lat, group = group)) + 
  geom_polygon(aes(fill =wage))+
  geom_path(color = 'white', size =.2, alpha = .5)+
  geom_polygon(data = state_df, color  = "black", fill = NA)+
  
  scale_fill_brewer(palette = "GnBu")+
  labs(x= '', y='',fill = 'Avg Annual PAy by County')
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank())
  
```

## Geography from industry level

According to North American Industry Classification System, we chose to focus on and visualize the geographical distribution of employment in the private sector across the 4 industries:  
* **(NIACS 11)** Agriculture, forestry, fisheries, hunting;  
* **(NIACS 21)** Mining, quarrying, oil, and natural gas extraction;  
* **(NIACS 52)** Finance and insurance;  
* **(NIACS 54)** Professional technical service.

### `filter` certain industry data
```{r}
d.sectors <- filter(ann2018_full, 
                    industry_code %in% c(11,21,52,54),
                    own_code == 5, # private sector
                    agglvl_code == 74 # county level
                    )%>%
  select(state, county, industry_code, own_code, agglvl_code,
         industry_title, own_title, avg_annual_pay, annual_avg_emplvl)%>%
  mutate(wage = Discretize(avg_annual_pay),
         emplevel = Discretize(annual_avg_emplvl ) ) 
d.sectors <- filter(d.sectors, !is.na(industry_code))

```

### visualization
```{r ,fig.width=12, fig.height=8}
chor_ind_cty <- left_join(cty_df, d.sectors)
chor_ind_cty <- filter(chor_ind_cty, !is.na(industry_code))
ggplot(chor_ind_cty, aes(long, lat, group = group))+
  geom_polygon( aes(fill= emplevel)) +
  geom_polygon(data = state_df, color = 'black', fill =NA)+
  scale_fill_brewer(palette = 'GnBu')+
  facet_wrap(~industry_title, ncol =2, as.table = T)+
  labs(fill = 'Avg Employment Level', x= '', y= '')+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank())
  
```

## Time series map of geospatial

### import data from 2008 to 2018
```{r}
library(dplyr)
getdata <- function(zipfile){
  unzip(file.path('data/',zipfile), exdir = 'data')
  csvfile <- gsub('zip', 'csv',zipfile)
  csvfile <- gsub('_', '.',csvfile)
  dat <- fread(file.path('data/',csvfile))
  
  dat <- left_join(dat, myarea)
  dat %<>% filter(agglvl_code == 70) %>% # county level
    select(state , county , avg_annual_pay)
  
  return(dat)
}

# store 11 yrs data in list
files <- dir('data', pattern = 'annual_singlefile.zip') # find pattern
n = length(files)
dat_list <- vector('list',n)
for (i in 1:n){
 dat_list[[i]] <- getdata(files[i])
 names(dat_list)[i] <- substr(files[i],1,4)
}

```

### Connect all the data together to create a unified discretization interval

```{r}
annpay <- ldply(dat_list)
breaks <- quantile(annpay$avg_annual_pay,
                    c(seq(0,.8,by=.2), .9, .95,.99,1))
```

### visualization

```{r custom visual func,fig.width=8, fig.height=4}
mychor_time <- function(d, fill_label = ''){
  
  # the dataset d will have a column named 'outcome'
  chor <- left_join(cty_df,d)
  plt <- ggplot(chor, aes(long, lat, group = group))+
  geom_polygon( aes(fill= outcome)) +
  geom_path(color = 'white', alpha = .5, size =.2)+
  geom_polygon(data = state_df, color = 'black', fill =NA)+
  scale_fill_brewer(palette = 'GnBu')+
  labs(fill = fill_label, x= '', y= '')+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank())
  
  return(plt)
} 
```

```{r,fig.width=8, fig.height=4}
# Create a corresponding plot object for 2008-2018 data with a loop 
plt_list <- vector('list',n)
for(i in 1:n){
  dat_list[[i]] <- mutate(dat_list[[i]],
                          outcome = Discretize(avg_annual_pay, breaks = breaks))
  plt_list[[i]] <- mychor_time(dat_list[[i]]) + ggtitle(names(dat_list)[i])
}
```


### Generate an animated GIF web page file
```{r gif,fig.width=8, fig.height=4, eval=FALSE}
library(choroplethr)
choroplethr_animate(plt_list)
```

According to the gif, we can see areaEmployment and wealth in North Dakota, Nevada, Wyoming and Northeastern coastal are growingobviously rapidly in last decade.